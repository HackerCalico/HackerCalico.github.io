<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Magic_C2 | Hexo</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"复制"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: '确认'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>Magic_C2</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2024-08-04T13:11:04.000Z" id="date"> 2024-08-04</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2024-08-15T04:45:02.267Z" id="updated"> 2024-08-15</time></div></span></div></div><hr><div id="post-content"><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>Version: Magic C2 v1.0.0 Beta</p>
<p>项目: <a target="_blank" rel="noopener" href="https://github.com/HackerCalico/Magic_C2">https://github.com/HackerCalico/Magic_C2</a></p>
<p>我相信每一位黑客都有自己的梦想！而我的其中一个就是拥有一款自己的 C2，因为实在是太酷啦！</p>
<p>在首发版本的 Issues 中，我看到了大家反馈的许多问题。所以我在近两周的时间里进行了大范围的整改优化，最终得到此版本。虽然与一个成熟的 C2 框架还有一定距离，但也已经非常棒了！</p>
<p class='item-img' data-src='https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/1.png'><img src="https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/1.png" alt="1.png"></p>
<h3 id="项目亮点"><a href="#项目亮点" class="headerlink" title="项目亮点"></a>项目亮点</h3><p><mark>(1) 远程抗沙箱</mark></p>
<p>后门的 ShellCode Loader 本身具备通信功能，用户可远程查看沙箱检测数据，进而远程决定后门是否从 “待定” 阶段进入 “正式上线” 阶段，如图1。</p>
<p>确定进入 “正式上线” 阶段后，服务端会向后门发送 ShellCode 密钥，进而解密加载。</p>
<p>规避优势：</p>
<ol>
<li><p>即使传输与沙箱检测无关的数据，也可以利用时长绕过部分沙箱检测。</p>
</li>
<li><p>因为是人工判定，所以沙箱检测数据可以比常规方式更加灵活，比如图中获取的就是目标主机的截图。</p>
</li>
<li><p>ShellCode 密钥由服务端发送，在病毒分析中无法通过简单的方式跳过抗沙箱阶段得到 ShellCode 明文。</p>
</li>
</ol>
<p><mark>(2) 隐蔽的 ShellCode 调用接口</mark></p>
<p>本项目结合了 <u>No_X_Memory_ShellCode_Loader</u> 技术: <a target="_blank" rel="noopener" href="https://github.com/HackerCalico/No_X_Memory_ShellCode_Loader">https://github.com/HackerCalico/No_X_Memory_ShellCode_Loader</a></p>
<p>后门进入 “正式上线” 阶段后的所有非通信功能均通过 “自定义汇编解释器” 运行：</p>
<ol>
<li><p>客户端将功能 ShellCode 转为 “自定义汇编指令” ——&gt; 服务端</p>
</li>
<li><p>服务端 ——&gt; 后门 “自定义汇编解释器”</p>
</li>
</ol>
<p>规避优势：</p>
<ol>
<li><p>向后门注入任何新功能无需进行任何内存属性 (R&#x2F;W&#x2F;X) 修改操作。</p>
</li>
<li><p>内存中任何时候都不会出现新功能的 ShellCode 机器码。</p>
</li>
</ol>
<p><mark>(3) 告警通知</mark></p>
<p>服务端在处理无效的凭证或请求数据时，只会响应空白 &#x2F; 404，并向所有客户端告警，如图1。</p>
<p><mark>(4) 文件分块传输</mark></p>
<p>文件上传下载均采用分块传输，支持随时暂停、取消与修改块的大小。</p>
<p class='item-img' data-src='https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/2.png'><img src="https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/2.png" alt="7.png"></p>
<p><mark>(5) 二次开发</mark></p>
<p>项目完全开源，代码简洁，未使用高级语法，插件均为 Python，易于二次开发。</p>
<h3 id="二次开发"><a href="#二次开发" class="headerlink" title="二次开发"></a>二次开发</h3><p><mark>(1) 插件开发</mark></p>
<p>在 Client\script 文件夹中可以看到所有插件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">Client<br>|— script<br>    |— cmd<br>    |— inject<br>    |— help<br>    |— GetFileInfoList_<br>    |— UploadFile_<br>    ......<br></code></pre></td></tr></table></figure>

<p>其中所有非 “_” 结尾的插件均为 “命令终端” 模块的插件，模块如图。</p>
<p>所有插件功能均通过 “自定义汇编解释器” 运行，所以必须先学习 <a target="_blank" rel="noopener" href="https://github.com/HackerCalico/No_X_Memory_ShellCode_Loader">https://github.com/HackerCalico/No_X_Memory_ShellCode_Loader</a></p>
<p>Python 编写规范可参考 cmd 插件。</p>
<p class='item-img' data-src='https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/3.png'><img src="https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/3.png" alt="2.png"></p>
<p>目前其他 “_” 结尾的插件均为 “文件管理” 模块的插件，模块如图。</p>
<p class='item-img' data-src='https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/4.png'><img src="https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/4.png" alt="3.png"></p>
<p><mark>(2) 后门开发</mark></p>
<p>在 Shell 文件夹中可以看到 “HTTP 反向 Shell” 和 “HTTP 反向 Loader” 的源码项目。</p>
<p>“HTTP 反向 Shell” 为核心功能的 “反射 DLL ShellCode” 项目。</p>
<p>“HTTP 反向 Loader” 为其 “ShellCode Loader” 项目，包含了 “远程抗沙箱” 功能。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">Shell<br>|— HttpReverseShell<br>    |— HttpReverseShell.sln<br>|— HttpReverseLoader<br>    |— HttpReverseLoader.sln<br></code></pre></td></tr></table></figure>

<p>ShellCode Loader 生命周期：</p>
<p class='item-img' data-src='https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/5.png'><img src="https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/5.png" alt="2.png"></p>
<p>ShellCode 生命周期：</p>
<p class='item-img' data-src='https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/6.png'><img src="https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/6.png" alt="3.png"></p>
<p><mark>(3) 生成器开发</mark></p>
<p>在 Shell\Generator 文件夹中可以看到一个 NormalXor 生成器文件夹，NormalXor 文件夹中有一个 Generator.py 和一个 Profile.txt。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">Shell<br>|— Generator<br>    |— NormalXor<br>        |— Generator.py<br>        |— Profile.txt<br></code></pre></td></tr></table></figure>

<p>在使用 “后门生成” 模块时，只要选择 Profile.txt，客户端就会调用与 Profile.txt 同文件夹下的 Generator.py 对后门源码进行 修改代码 - 编译代码 - 还原代码，来生成 ShellCode、EXE。</p>
<p>用户可以在 Generator 文件夹中创建不同的生成器文件夹，也可以在一个生成器文件夹中创建不同 Profile.txt。</p>
<p><mark>(4) 更多二次开发</mark></p>
<p>可以结合 “命令控制模型” (客户端 - 服务端 - 后门) 对项目源码进行更深的理解。</p>
<p class='item-img' data-src='https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/7.png'><img src="https://raw.githubusercontent.com/HackerCalico/Magic_C2/main/Client/bin/Debug/config/README/7.png" alt="4.png"></p>
<h3 id="免责声明"><a href="#免责声明" class="headerlink" title="免责声明"></a>免责声明</h3><p>(1) 本项目仅用于网络安全技术的学习研究。旨在提高安全开发能力，研发新的攻防技术。</p>
<p>(2) 若执意要将本项目用于渗透测试等安全业务，需先确保已获得足够的法律授权，在符合网络安全法的条件下进行。</p>
<p>(3) 本项目由个人独立开发，暂未做全面的软件测试，请使用者在虚拟环境中测试本项目的功能。</p>
<p>(4) 本项目完全开源，请勿将本项目用于任何商业用途。</p>
<p>(5) 若使用者在使用本项目的过程中存在任何违法行为或造成任何不良影响，需使用者自行承担责任，与项目作者无关。</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-start"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2024/08/13/%E6%97%A0%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%9D%83%E9%99%90%E5%8A%A0%E8%BD%BD%20ShellCode%20%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86/">← 下一篇 无可执行权限加载 ShellCode 技术原理</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">John Doe</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BA%AE%E7%82%B9"><span class="toc-number">2.</span> <span class="toc-text">项目亮点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91"><span class="toc-number">3.</span> <span class="toc-text">二次开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%8D%E8%B4%A3%E5%A3%B0%E6%98%8E"><span class="toc-number">4.</span> <span class="toc-text">免责声明</span></a></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> 主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>